#include "i2c-lcd.h"

static I2C_HandleTypeDef *_hi2c;
static uint8_t backlight_state = LCD_BACKLIGHT;

static void lcd_send_internal(uint8_t data, uint8_t flags) {
    HAL_StatusTypeDef res;
    for (uint8_t i = 0; i < 2; i++) {
        uint8_t nibble = (i == 0) ? (data & 0xF0) : ((data << 4) & 0xF0);
        uint8_t data_arr[4];
        data_arr[0] = nibble | flags | backlight_state | 0x04; // EN=1
        data_arr[1] = nibble | flags | backlight_state;        // EN=0
        res = HAL_I2C_Master_Transmit(_hi2c, LCD_I2C_ADDR, data_arr, 2, HAL_MAX_DELAY);
        HAL_Delay(1);
    }
}

void lcd_send_cmd(char cmd) {
    lcd_send_internal(cmd, 0x00);
}

void lcd_send_data(char data) {
    lcd_send_internal(data, 0x01); // RS = 1
}

void lcd_clear(void) {
    lcd_send_cmd(LCD_CLR);
    HAL_Delay(2);
}

void lcd_put_cur(uint8_t row, uint8_t col) {
    uint8_t addr = (row == 0) ? 0x80 : 0xC0;
    addr += col;
    lcd_send_cmd(addr);
}

void lcd_send_string(char *str) {
    while (*str) {
        lcd_send_data(*str++);
    }
}

void lcd_init(I2C_HandleTypeDef *hi2c) {
    _hi2c = hi2c;
    HAL_Delay(50); // wait for LCD to power up

    lcd_send_cmd(0x30);
    HAL_Delay(5);
    lcd_send_cmd(0x30);
    HAL_Delay(1);
    lcd_send_cmd(0x30);
    HAL_Delay(10);
    lcd_send_cmd(0x20); // 4-bit mode

    lcd_send_cmd(LCD_FUNCTIONSET | LCD_2LINE | LCD_5x8DOTS | LCD_4BITMODE);
    lcd_send_cmd(LCD_DISPLAYCTRL | LCD_DISPLAYON | LCD_CURSOROFF | LCD_BLINKOFF);
    lcd_clear();
    lcd_send_cmd(LCD_ENTRYMODE | 0x02); // Entry mode set
}
